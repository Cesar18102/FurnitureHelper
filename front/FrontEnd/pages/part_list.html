<html>
	<head>
		<meta charset="utf-8"/>
		<title>Furniture Helper</title>
		<link rel="stylesheet" href="../styles/common.css"/>
		<link rel="stylesheet" href="../styles/page_wrapper.css"/>
		<link rel="stylesheet" href="../styles/fall_down_menu.css"/>
		<link rel="stylesheet" href="../styles/loader.css"/>
		<link rel="stylesheet" href="../styles/part_list.css"/>
		<script src="../scripts/libs/vue.js"></script>
		<script src="../scripts/libs/jquery.js"></script>
		<script src="../scripts/libs/three.js"></script>
		<script src="../scripts/connector.js"></script>
		<script src="../scripts/continious_handler.js"></script>
		<script src="../scripts/response_handler.js"></script>
	</head>
	<body>
		<div id="header-wrapper"></div>
		
		<div class="content">
			<div id="loader" class="centered-loader default-loader"></div>
			<div id="part-list-wrapper" class="default-list">
				<div v-for="partEntry in partStore" class="default-list-item">
					<div class="part-info">
						#{{ partEntry.part.id }} "{{ partEntry.part.name }}" <span v-if="partEntry.part.description != ''">â€” {{ partEntry.part.description }}</span>
					</div>
					<div class="part-price">
						{{ partEntry.part.price }}UAH
					</div>
					<div v-for="material in partEntry.part.possible_materials" class="part-material-differ-list">
						<div v-for="color in material.possible_colors" class="part-color-differ-list">
							<div v-bind:model="partEntry.part.model_url" 
								 v-bind:texture="material.texture_url" 
								 v-bind:color="color.hex" 
								 v-bind:title="color.name"
								 class="part-sampler" 
							></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="footer"></div>
		
		<script id="vertexShader" type="x-shader/x-vertex">
			uniform float time;
			uniform vec2 resolution;
			void main()	{
				gl_Position = vec4( position, 1.0 );
			}
		</script>

		<script id="fragmentShader" type="x-shader/x-fragment">
			uniform float time;
			uniform vec2 resolution;
			void main()	{
				gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
			}
		</script>
		
		<script>
			$(function(){ $("#header-wrapper").load("header.html"); });
		
			async function init() {
				let loader = document.getElementById("loader");
				partListHandler(await handleContinious(getPartList, loader));
			}
			
			async function getPartList() {
				return await SendGetAsync("part/get");
			}
			
			function partListHandler(result) {
				handleResponse(
					result,
					error => alert(error.error_message),
					data => buildPartList(data)
				);
			}
			
			function buildPartList(partList) {
				new Vue({
					el : "#part-list-wrapper",
					data : { partStore : partList.positions } 
				});
			}
			
			function render(renderer, scene, camera, motion) {
				requestAnimationFrame(() => render(renderer, scene, camera, motion));
				renderer.render(scene, camera);
				motion();
			}
			
			function initPartRenderers() {
				let partRenderers = $(".part-sampler");
				for(let partRenderer of partRenderers) {
					let hex = partRenderer.getAttribute("color");
					let red = parseInt(hex.substr(0, 2), 16) / 256;
					let green = parseInt(hex.substr(2, 2), 16) / 256;
					let blue = parseInt(hex.substr(4, 2), 16) / 256;
					let alpha = parseInt(hex.substr(6, 2), 16) / 256;
					
					let textureUrl = partRenderer.getAttribute("texture");
					let modelUrl = partRenderer.getAttribute("model");
				
					let scene = new THREE.Scene();
					scene.background = new THREE.Color(0xFFFFFF);
					
					let renderer = new THREE.WebGLRenderer();
					renderer.shadowMap.enabled = true;
					renderer.shadowMap.type = THREE.PCFSoftShadowMap;
					renderer.domElement.classList.add("part-renderer");
					renderer.setSize(partRenderer.offsetWidth, partRenderer.offsetHeight);
					partRenderer.appendChild(renderer.domElement);
					
					let camera = new THREE.PerspectiveCamera(30, partRenderer.offsetWidth / partRenderer.offsetHeight, 0.1, 1000);
					camera.position.set(2, 3, 5);
					camera.lookAt(new THREE.Vector3(0, 0, 0));
					
					let partGeometry = new THREE.BoxGeometry().rotateY(-0.4);
					let partTexture = new THREE.TextureLoader().load(textureUrl);
					let partMaterial = new THREE.MeshMatcapMaterial( { map: partTexture } );
					
					partMaterial.onBeforeCompile = shader => {
						shader.uniforms.mycolor = { value : new THREE.Color(red * alpha, green * alpha, blue * alpha) };
						shader.fragmentShader = shader.fragmentShader.replace(
							"uniform vec3 diffuse;", 
							"uniform vec3 mycolor;\nuniform vec3 diffuse;"
						);
						shader.fragmentShader = shader.fragmentShader.replace(
							"gl_FragColor = vec4( outgoingLight", 
							"outgoingLight = vec3((outgoingLight.x + mycolor.x) / 2.0, (outgoingLight.y + mycolor.y) / 2.0, (outgoingLight.z + mycolor.z) / 2.0);\n gl_FragColor = vec4( outgoingLight"
						);
					};
					
					let part = new THREE.Mesh(partGeometry, partMaterial);
					part.castShadow = true;
					scene.add(part);
					
					let light = new THREE.PointLight(0xFFFFFF, 1);
					light.position.set(10, 10, 10);
					light.castShadow = true;
					scene.add(light);
					
					let bottomPlaneGeometry = new THREE.PlaneGeometry(20, 20, 32, 32).rotateX(-Math.PI / 2).translate(0, -2, 0);
					let bottomPlaneMaterial = new THREE.MeshPhysicalMaterial( { color: 0xFFFFFF } );
					let bottomPlane = new THREE.Mesh(bottomPlaneGeometry, bottomPlaneMaterial);
					bottomPlane.receiveShadow = true;
					scene.add(bottomPlane);
					
					let backPlaneGeometry = new THREE.PlaneGeometry(20, 20, 32, 32).translate(0, 0, -2);
					let backPlaneMaterial = new THREE.MeshPhysicalMaterial( { color: 0xEEEEEE } );
					let backPlane = new THREE.Mesh(backPlaneGeometry, backPlaneMaterial);
					backPlane.receiveShadow = true;
					scene.add(backPlane);
					
					let leftPlaneGeometry = new THREE.PlaneGeometry(20, 20, 32, 32).rotateY(Math.PI / 2).translate(-2, 0, 0);
					let leftPlaneMaterial = new THREE.MeshPhysicalMaterial( { color: 0xDDDDDD } );
					let leftPlane = new THREE.Mesh(leftPlaneGeometry, leftPlaneMaterial);
					leftPlane.receiveShadow = true;
					scene.add(leftPlane);
					
					render(renderer, scene, camera, () => {
						part.geometry.rotateX(0.01);
						part.geometry.rotateY(0.01);
					});
				}
			}
			
			init();
			$(document).ready(() => initPartRenderers());
		</script>
	</body>
</html>