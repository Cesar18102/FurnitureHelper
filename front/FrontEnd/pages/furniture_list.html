<html>
	<head>
		<meta charset="utf-8"/>
		<title>Furniture Helper</title>
		<link rel="stylesheet" href="../styles/common.css"/>
		<link rel="stylesheet" href="../styles/page_wrapper.css"/>
		<link rel="stylesheet" href="../styles/fall_down_menu.css"/>
		<link rel="stylesheet" href="../styles/loader.css"/>
		<link rel="stylesheet" href="../styles/furniture_list.css"/>
		<link rel="stylesheet" href="../styles/default_form.css"/>
		<link rel="stylesheet" href="../styles/popup.css"/>
		
		<script src="../scripts/libs/vue.js"></script>
		<script src="../scripts/libs/three.js"></script>
		<script src="../scripts/libs/OBJLoader.js"></script>
		<script src="../scripts/libs/jquery.js"></script>
		
		<script src="../scripts/popup.js"></script>
		<script src="../scripts/connector.js"></script>
		<script src="../scripts/continious_handler.js"></script>
		<script src="../scripts/response_handler.js"></script>
		<script src="../scripts/draw/furniture_render.js"></script>
	</head>
	<body>
		<div id="header-wrapper"></div>
		
		<div class="content">
			<div id="loader" class="centered-loader default-loader"></div>
			<div id="furniture-list-wrapper" class="default-list">
				<div v-for="furniture in furnitures" class="default-list-item">
					<div class="furniture-info">
						#{{ furniture.id }} "{{ furniture.name }}"
						<span v-if="furniture.description != ''">— {{ furniture.description }}</span>
					</div>
					<br/>
					<div>Ingredients:</div>
					<br/>
					<div v-for="(partID, partInfo) in furniture | ingredients">
						#{{ partID }}, "{{ partInfo.name }}" — {{ partInfo.count }}
					</div>
					<div v-bind:id="furniture | rendererId" class="furniture-sampler">
					</div>
				</div>
			</div>
		</div>
		
		<center id="errorPopupHolder"></center>
		
		<div class="footer"></div>
		
		<script>
		
			Vue.filter("rendererId", furniture => "furniture-renderer-wrapper-" + furniture.id);
			Vue.filter("ingredients", furniture => {
				let groups = {};
				for(let used of furniture.used_parts) {
					if(groups[used.part_id] == undefined) {
						groups[used.part_id] = { count : 0 };
					}
					++groups[used.part_id].count;
				}
				
				for(let id in groups) {
					let part = getPart(furniture, part => part.id == id);
					groups[id].name = part.name;
				}
				
				return groups;
			});
		
			let error = { message : undefined };
			let errorPopup = createPopup({
				holder : "errorPopupHolder", bodyStyle : "popup-body", wrapperStyle : "popup-wrapper",
				content : "<div id='errorPopup'>{{ message }}</div>",
				vue : () => {
					new Vue({
						el : "#errorPopup",
						data : error
					});
				}
			});
			
			async function init() {
				let loader = document.getElementById("loader");
				furnitureListHandler(await handleContinious(getFurnitureList, loader));
		
				$(function(){ $("#header-wrapper").load("header.html"); });
			}
			
			async function getFurnitureList() {
				return await SendGetAsync("furniture/get");
			}
			
			function furnitureListHandler(result) {
				handleResponse(
					result,
					err => {
						error.message = err.error_message;
						errorPopup.show();
					},
					data => buildFurnitureList(data)
				);
			}
			
			function buildFurnitureList(list) {
				let vm = new Vue({
					el : "#furniture-list-wrapper",
					data : { furnitures : list },
				});
				
				for(let furniture of list) {
					let wrapper = document.getElementById("furniture-renderer-wrapper-" + furniture.id);
					renderFurniture(furniture, wrapper, "furniture-renderer");
				}
			}
			
			init();
			
		</script>
	</body>
</html>